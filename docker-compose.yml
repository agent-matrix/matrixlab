services:
  runner:
    build:
      context: ./runner
    image: matrix-lab-runner:latest
    # IMPORTANT: runner must be able to talk to the host Docker daemon to spawn sandboxes.
    # For reliability across Linux/WSL/macOS, run runner as root when using docker.sock.
    user: "0:0"
    ports:
      - "8000:8000"
    volumes:
      # DEV / SINGLE-HOST MODE:
      # This projectâ€™s current architecture uses the host Docker daemon via docker.sock.
      # In hardened production, replace this with a dedicated executor runtime instead of mounting docker.sock.
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      # Runner-side behavior controls (optional)
      - MATRIXLAB_DOCKER_PULL=missing
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/health', timeout=2).read(); print('ok')"]
      interval: 2s
      timeout: 2s
      retries: 30
      start_period: 5s
    restart: unless-stopped
    depends_on:
      - sandbox-utils
      - sandbox-python
      - sandbox-go
      - sandbox-rust
      - sandbox-node

  # Matrix utility sandbox for unzip/inspect/tree/grep/detect
  sandbox-utils:
    build:
      context: ./sandbox-utils
    image: matrix-lab-sandbox-utils:latest

  sandbox-python:
    build:
      context: ./sandbox-python
    image: matrix-lab-sandbox-python:latest

  sandbox-go:
    build:
      context: ./sandbox-go
    image: matrix-lab-sandbox-go:latest

  sandbox-rust:
    build:
      context: ./sandbox-rust
    image: matrix-lab-sandbox-rust:latest

  sandbox-node:
    build:
      context: ./sandbox-node
    image: matrix-lab-sandbox-node:latest

  # Optional demo client (uncomment if you want it to run automatically)
  # orchestrator:
  #   build:
  #     context: ./orchestrator
  #   image: matrix-lab-orchestrator:latest
  #   environment:
  #     - RUNNER_URL=http://runner:8000
  #     - REPO_URL=https://github.com/pallets/flask.git
  #     - REPO_REF=main
  #   depends_on:
  #     - runner
  #     - sandbox-utils
  #     - sandbox-python
  #     - sandbox-go
  #     - sandbox-rust
  #     - sandbox-node
